@attribute [CascadingTypeParameter(nameof(TItem))]
@typeparam TItem

<CascadingValue Value="this" IsFixed>
    @ChildContent
    <Defer>
        <div class="data-grid">
            @foreach (var column in Columns)
            {
                <div class="data-grid-column" style="@GetColumnStyle(column)" />
            }

            <div class="data-grid-header">
                @foreach (var column in Columns)
                {
                    <div class="data-grid-cell">
                        @column.HeaderContent
                    </div>
                }
            </div>

            @if (Virtualize)
            {
                <Virtualize Context="item" Items="Items is ICollection<TItem> items ? items : Items?.ToArray()" ItemsProvider="ItemsProvider" OverscanCount="OverscanCount">
                    <ItemContent>
                        <div class="data-grid-row" @key="item">
                            @foreach (var column in Columns)
                            {
                                <div class="data-grid-cell">
                                    @column.CellContent(item)
                                </div>
                            }
                        </div>
                    </ItemContent>
                    <Placeholder>
                        <div class="data-grid-row">
                            @foreach (var column in Columns)
                            {
                                <div class="data-grid-cell">
                                    @column.Placeholder
                                </div>
                            }
                        </div>
                    </Placeholder>
                </Virtualize>
            }
            else
            {
                foreach (var item in Items ?? [])
                {
                    <div class="data-grid-row" @key="item">
                        @foreach (var column in Columns)
                        {
                            <div class="data-grid-cell">
                                @column.CellContent(item)
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </Defer>
</CascadingValue>

@code {
    [Parameter, Description("Place columns here. Columns must derive from <code>DataGridColumn</code>.")]
    public RenderFragment? ChildContent { get; set; }

    private List<DataGridColumn<TItem>> Columns { get; } = [];

    [Parameter, Description("Fixed collection that determines the grid's rows.")]
    public IEnumerable<TItem>? Items { get; set; }

    [Parameter, Description("Delegate called when data is requested, used for data virtualization. Only works when <code>Virtualize</code> is true.")]
    public ItemsProviderDelegate<TItem>? ItemsProvider { get; set; }

    [Parameter, Description("When virtualizing, controls how many out-of-view items are loaded. Defaults to <code>3</code>.")]
    public int OverscanCount { get; set; } = 3;

    [Parameter, Description("Enabled UI virtualization when true.")]
    public bool Virtualize { get; set; }

    internal void AddColumn(DataGridColumn<TItem> column)
        => Columns.Add(column);

    private string GetColumnStyle(DataGridColumn<TItem> column)
    {
        return StyleList.Create("width", column.Width switch
        {
            { Unit: SizeUnit.Auto } size => "auto",
            { Unit: SizeUnit.Custom } size => size.Value,
            { Unit: SizeUnit.Exact } size => $"{size.Magnitude}px",
            { Unit: SizeUnit.Fill } size => $"calc({size.Magnitude} / {Columns.Where(c => c.Width.Unit == SizeUnit.Fill).Sum(c => c.Width.Magnitude)} * 100%)",
            { } size => throw new NotImplementedException($"Column width {size} is not supported")
        });
    }
}
